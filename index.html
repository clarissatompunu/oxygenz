<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OxyGenZ - Global Eco Network</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* THEME & STYLES */
        :root {
            --primary: #00b894; --primary-dark: #008f7a; --accent: #55efc4;
            --text: #2d3436; --card-bg: rgba(255, 255, 255, 0.95);
            --bg-mint: linear-gradient(135deg, #ffffff 0%, #d1f2eb 100%);
            --correct-bg: #d1fae5; --correct-border: #10b981; --correct-text: #065f46;
            --wrong-bg: #fee2e2; --wrong-border: #ef4444; --wrong-text: #991b1b;
        }

        body {
            background: var(--bg-mint);
            height: 100vh; display: flex; overflow: hidden; color: var(--text);
            transition: background 1s ease-in-out;
        }

        body.env-polluted { background: linear-gradient(135deg, #636e72 0%, #b2bec3 100%); }
        body.env-moderate { background: linear-gradient(135deg, #ff9f43 0%, #feca57 100%); }
        body.env-clean { background: linear-gradient(135deg, #00b894 0%, #81ecec 100%); }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', sans-serif; }
        .hidden { display: none !important; }
        button { cursor: pointer; transition: 0.2s; font-family: 'Nunito', sans-serif; }
        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }

        /* LOADING SPINNER */
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* TOAST */
        .toast { position: fixed; top: 20px; right: 20px; background: var(--text); color: white; padding: 15px 25px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 2000; animation: slideIn 0.5s; font-weight: 800; display: flex; align-items: center; gap: 10px;}
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* AUTH SECTION */
        #auth-section { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .auth-container { background: rgba(255,255,255,0.9); padding: 40px; width: 450px; border-radius: 35px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.1); border: 5px solid #ffffff; backdrop-filter: blur(10px); }
        .logo-emoji { font-size: 4rem; display: block; margin-bottom: 5px; animation: bounce 2s infinite; }
        .logo-text { font-weight: 800; font-size: 3rem; color: var(--primary); margin-bottom: 5px; letter-spacing: -1px; }
        .auth-welcome { font-size: 1.2rem; font-weight: 700; color: var(--primary-dark); margin-bottom: 5px; }
        .auth-sub { font-size: 0.95rem; color: #636e72; margin-bottom: 25px; font-weight: 600; line-height: 1.4; }
        .auth-box input { width: 100%; padding: 15px; margin: 8px 0; border: 3px solid #edf2f7; border-radius: 15px; font-size: 1rem; transition: 0.3s; background: #f7fafc; color: var(--text); font-weight: 600; }
        .auth-box input:focus { border-color: var(--accent); outline: none; background: white; }
        .btn-group { display: flex; gap: 10px; margin-top: 25px; }
        .btn-auth { flex: 1; padding: 12px; border: none; border-radius: 15px; font-weight: 800; font-size: 1rem; }
        .btn-login { background: var(--primary); color: white; box-shadow: 0 5px 0 var(--primary-dark); }
        .btn-login:active { transform: translateY(3px); box-shadow: none; }
        .btn-register { background: white; color: var(--primary); border: 3px solid var(--primary); box-shadow: 0 5px 0 #dfe6e9; }
        .btn-register:active { transform: translateY(3px); box-shadow: none; }

        /* DASHBOARD LAYOUT */
        #dashboard-section { display: flex; width: 100%; height: 100%; }
        .sidebar { width: 280px; background: rgba(255,255,255,0.8); padding: 40px 25px; display: flex; flex-direction: column; border-right: 2px solid white; backdrop-filter: blur(15px); }
        .user-profile { text-align: center; margin-bottom: 40px; }
        .avatar { font-size: 4rem; background: #d1f2eb; width: 100px; height: 100px; line-height: 100px; border-radius: 50%; margin: 0 auto 15px; border: 5px solid white; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .user-name { font-size: 1.4rem; font-weight: 800; margin-bottom: 5px; }
        .user-badge { background: var(--accent); color: var(--primary-dark); padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 700; }
        .nav-links li { list-style: none; padding: 15px 20px; border-radius: 18px; margin-bottom: 10px; font-weight: 700; color: #636e72; display: flex; align-items: center; gap: 12px; font-size: 1.05rem; }
        .nav-links li:hover, .nav-links li.active-nav { background: var(--primary); color: white; box-shadow: 0 8px 20px rgba(0, 184, 148, 0.3); transform: translateX(5px); }
        .content { flex: 1; padding: 40px; overflow-y: auto; }
        header { margin-bottom: 35px; display: flex; align-items: center; gap: 15px; }
        header h1 { font-size: 2.5rem; color: var(--primary-dark); font-weight: 800; }
        
        /* CARDS */
        .card { background: var(--card-bg); padding: 35px; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); margin-bottom: 30px; border: 3px solid white; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 40px; }
        .stat-card { text-align: center; padding: 30px 20px; background: linear-gradient(145deg, #ffffff, #f0f9f4); }
        .stat-emoji { font-size: 3rem; margin-bottom: 10px; display: block; }
        .stat-value { font-size: 3rem; color: var(--primary); font-weight: 900; }
        .aqi-container { display: flex; gap: 40px; align-items: center; justify-content: center; padding: 10px; }
        .aqi-circle { width: 200px; height: 200px; border-radius: 50%; background: white; border: 12px solid #ffeaa7; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: 0 15px 40px rgba(0,0,0,0.1); position: relative; }
        .aqi-val { font-size: 4.5rem; color: #fab1a0; line-height: 1; font-weight: 900; }
        .aqi-emoji { font-size: 5rem; position: absolute; top: -20px; right: -20px; animation: float 3s infinite ease-in-out; }

        /* GAME */
        .game-container { display: flex; gap: 40px; justify-content: center; align-items: start; }
        .game-sidebar { flex: 1; max-width: 300px; }
        .score-box { background: var(--primary); color: white; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 8px 0 var(--primary-dark); margin-bottom: 25px;}
        .score-val { font-size: 3rem; font-weight: 900; }
        .game-board-container { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.15); border: 5px solid white; backdrop-filter: blur(5px); }
        .game-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .tile { width: 90px; height: 90px; background: rgba(238, 228, 218, 0.5); border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 3.5rem; font-weight: 800; transition: all 0.15s ease-in-out; box-shadow: inset 0 3px 5px rgba(255,255,255,0.5), 0 3px 5px rgba(0,0,0,0.05); }
        .t-2 { background: #eee4da; } .t-4 { background: #ede0c8; } .t-8 { background: #f2b179; color: white; } .t-16 { background: #f59563; color: white; } .t-32 { background: #f67c5f; color: white; } .t-64 { background: #f65e3b; color: white; } .t-128 { background: #edcf72; color: white; font-size: 4rem; animation: pulse 1.5s infinite; }
        .powerup-box { display: flex; gap: 10px; margin-top: 15px; }
        .p-btn { flex: 1; padding: 10px; border: none; border-radius: 12px; font-weight: 700; font-size: 0.8rem; background: white; color: var(--text); border: 2px solid #dfe6e9; transition: 0.2s; box-shadow: 0 3px 0 #b2bec3; }
        .p-btn:hover { transform: translateY(-2px); border-color: var(--primary); color: var(--primary); }
        .p-cost { display: block; font-size: 0.7rem; color: #fab1a0; font-weight: 900; margin-top: 3px; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1500; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-card { background: white; padding: 40px; border-radius: 30px; width: 90%; max-width: 500px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); animation: popUp 0.4s; border: 5px solid var(--accent); }
        .modal-emoji { font-size: 5rem; margin-bottom: 10px; display: block; animation: bounce 2s infinite; }
        .modal-title { font-size: 2rem; color: var(--primary-dark); margin-bottom: 15px; }
        .modal-btn { background: var(--primary); color: white; border: none; padding: 15px 30px; border-radius: 15px; font-size: 1.2rem; font-weight: 800; box-shadow: 0 5px 0 var(--primary-dark); margin-top: 20px;}
        @keyframes popUp { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        /* REUSABLES */
        .quiz-card-item { background: white; padding: 25px; border-radius: 20px; border: 3px solid #e0f2f1; text-align: center; transition: 0.3s; cursor: pointer; }
        .quiz-card-item:hover { transform: translateY(-5px); border-color: var(--primary); }
        .rank-card { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 15px; transition: 0.3s; border: 3px solid transparent; }
        .rank-card:hover { transform: scale(1.02); }
        .rank-1 { border-color: #ffd700; background: #fffde7; } .rank-2 { border-color: #bdc3c7; background: #f5f6fa; } .rank-3 { border-color: #d35400; background: #fbe9e7; }
        .rank-score { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        
        /* QUIZ BUTTONS - REVISI DESAIN */
        .option-btn {
            background: white;
            padding: 18px 25px;
            border-radius: 18px; /* Lebih rounded */
            border: 3px solid #dfe6e9;
            box-shadow: 0 5px 0 #b2bec3; /* EFEK 3D */
            text-align: left;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 800; /* Lebih tebal */
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .option-btn:hover {
            transform: translateY(-3px);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 8px 0 #b2bec3;
        }
        .option-btn:active {
            transform: translateY(3px);
            box-shadow: 0 0 0 #b2bec3; /* Tekan ke bawah */
        }
        /* State Colors */
        .option-btn.correct { background: var(--correct-bg); border-color: var(--correct-border); color: var(--correct-text); box-shadow: 0 5px 0 var(--correct-border); }
        .option-btn.wrong { background: var(--wrong-bg); border-color: var(--wrong-border); color: var(--wrong-text); box-shadow: 0 5px 0 var(--wrong-border); }
        .option-btn.disabled { pointer-events: none; opacity: 0.9; } /* Opacity lebih tinggi biar jelas */
        
        .option-marker { width: 35px; height: 35px; background: #dfe6e9; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 800; color: #636e72; font-size: 1.1rem; }
        .option-btn.correct .option-marker { background: var(--correct-border); color: white; }
        .option-btn.wrong .option-marker { background: var(--wrong-border); color: white; }

        /* Nav Buttons in Quiz */
        .quiz-nav-btns { display: flex; justify-content: space-between; margin-top: 20px; }
        .nav-btn { padding: 12px 25px; border-radius: 12px; font-weight: 800; border: none; font-size: 1rem; box-shadow: 0 4px 0 rgba(0,0,0,0.1); cursor:pointer; }
        .btn-prev { background: #b0bec5; color: white; box-shadow: 0 4px 0 #7f8c8d; }
        .btn-next { background: var(--primary); color: white; box-shadow: 0 4px 0 var(--primary-dark); }
        .btn-submit { background: #ff7675; color: white; width: 100%; margin-top: 20px; padding: 15px; border-radius: 15px; font-size: 1.2rem; font-weight: 800; box-shadow: 0 5px 0 #d63031; border: none; cursor:pointer;}
        .btn-submit:hover, .btn-next:hover { transform: translateY(-2px); }
        .btn-submit:active, .btn-next:active { transform: translateY(2px); box-shadow:none; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="hidden"><div class="spinner"></div></div>
    <div id="toast" class="toast hidden"><span>üîî</span> <span id="toast-msg">Notification</span></div>
    <div id="baloon-container"></div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-card">
            <span id="modal-emoji" class="modal-emoji">üåü</span>
            <h2 id="modal-title" class="modal-title">Title</h2>
            <p id="modal-text" style="font-size:1.1rem; color:#636e72; line-height:1.6;">Text</p>
            <button onclick="closeModal()" class="modal-btn">Awesome!</button>
        </div>
    </div>

    <section id="auth-section" class="active">
        <div class="auth-container">
            <span class="logo-emoji">üå±</span>
            <h1 class="logo-text">OxyGenZ</h1>
            <p class="auth-welcome">Welcome back, Eco-Warrior! üëã</p>
            <p class="auth-sub">Register yourself to play with us,<br>or Log In to continue saving the planet!</p>
            <div class="auth-box">
                <input type="text" id="auth-user" placeholder="Username (Unique ID)">
                <input type="password" id="auth-pass" placeholder="Password">
                <div class="btn-group">
                    <button class="btn-auth btn-login" onclick="handleLogin()">Log In</button>
                    <button class="btn-auth btn-register" onclick="handleRegister()">Register</button>
                </div>
            </div>
        </div>
    </section>

    <section id="dashboard-section" class="hidden">
        <nav class="sidebar">
            <div class="user-profile">
                <div class="avatar">üë§</div>
                <h3 id="display-username" class="user-name">User</h3>
                <span class="user-badge">Level 1 Recycler</span>
            </div>
            <ul class="nav-links">
                <li onclick="showPage('overview')" id="nav-overview"><span>üè†</span> Overview</li>
                <li onclick="showPage('missions')" id="nav-missions"><span>üéØ</span> Missions</li>
                <li onclick="showPage('game')" id="nav-game"><span>üéÆ</span> Game Area</li>
                <li onclick="showPage('leaderboard')" id="nav-leaderboard"><span>üèÜ</span> Leaderboard</li>
                <li onclick="handleLogout()" class="logout-btn" style="margin-top: auto; color: #d63031;"><span>üö™</span> Logout</li>
            </ul>
        </nav>
        <main class="content">
            <div id="page-overview" class="page active">
                <header><span class="header-emoji">üìä</span><h1>Dashboard Overview</h1></header>
                <div class="stats-grid">
                    <div class="card stat-card"><span class="stat-emoji">üèÜ</span><span class="stat-title">TOTAL POINTS</span><h1 id="stat-points" class="stat-value">0</h1></div>
                    <div class="card stat-card"><span class="stat-emoji">üé´</span><span class="stat-title">YOUR TOKENS</span><h1 id="stat-tokens" class="stat-value">0</h1></div>
                    <div class="card stat-card"><span class="stat-emoji">‚ôªÔ∏è</span><span class="stat-title">AQI CLEANED</span><h1 id="stat-cleaned" class="stat-value">0</h1></div>
                </div>
                <div class="card aqi-box">
                    <div class="aqi-container">
                        <div class="aqi-circle">
                            <span id="aqi-emoji" class="aqi-emoji">üå´Ô∏è</span>
                            <span id="aqi-val" class="aqi-val">150</span>
                            <small class="aqi-label">CURRENT AQI</small>
                        </div>
                        <div><h2>Air Quality Status:</h2><h1 id="aqi-status" style="font-size: 2.5rem; color: #fab1a0; font-weight: 800;">UNHEALTHY</h1></div>
                    </div>
                </div>
            </div>

            <div id="page-missions" class="page hidden">
                <header><span class="header-emoji">üéØ</span><h1>Missions & Challenges</h1></header>
                <div class="card" id="quiz-menu-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2>üìù Quizzes</h2><span style="font-weight:700; color:#636e72;">Completed: <span id="quizzes-completed">0</span>/4</span>
                    </div>
                    <div id="quiz-menu" class="quiz-menu-grid"></div>
                </div>
                <div class="card hidden" id="quiz-interface-card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h2 id="active-quiz-title">Quiz Title</h2>
                        <button onclick="closeQuiz()" style="background:#e0e0e0; border:none; padding:8px 15px; border-radius:10px; font-weight:bold;">‚úï Exit</button>
                    </div>
                    <div id="quiz-game-area" class="quiz-active-container">
                        <div class="quiz-progress"><span id="q-progress-text">Question 1</span><span id="q-score-preview" style="color:var(--primary);">Score: 0</span></div>
                        <p id="q-text" class="question-text">Question?</p>
                        <div id="q-options" class="quiz-options"></div>
                        <div class="quiz-nav-btns">
                            <button id="btn-prev" class="nav-btn btn-prev" onclick="prevQuestion()" style="visibility:hidden;">‚¨Ö Prev</button>
                            <button id="btn-next" class="nav-btn btn-next" onclick="nextQuestion()">Next ‚û°</button>
                        </div>
                        <button id="btn-submit-quiz" class="btn-submit hidden" onclick="submitQuiz()">‚úÖ Finish & Collect Reward</button>
                    </div>
                    <div id="quiz-result-view" class="hidden" style="text-align:center; padding:30px;">
                        <span style="font-size:5rem;">üéâ</span><h2 style="font-size:2rem; margin:10px 0;">Quiz Completed!</h2>
                        <p style="font-size:1.2rem; color:#636e72;">You Scored:</p><h1 id="final-score-display" style="font-size:4rem; color:var(--primary); margin:10px 0;">0</h1>
                        <p>Reward: üèÜ +<span id="reward-pts">0</span> Pts & üé´ +2 Tokens</p>
                        <button onclick="closeQuiz()" class="modal-btn">Awesome! üòé</button>
                    </div>
                </div>
                <div class="card">
                    <header style="margin-bottom: 20px;"><span class="header-emoji">‚ö°</span><h2>Weekly Actions</h2></header>
                    <div id="challenges-container"></div>
                </div>
            </div>

            <div id="page-game" class="page hidden">
                <header><span class="header-emoji">üéÆ</span><h1>Pollution to Solution</h1></header>
                <div class="game-container">
                    <div class="game-sidebar">
                        <div class="score-box"><span class="score-label">GAME SCORE</span><h1 id="game-score" class="score-val">0</h1></div>
                        <div class="card" style="padding: 20px; text-align: center; background: #ffeaa7; border-color: #fdcb6e;">
                            <h3 style="color: #d35400; margin-bottom: 10px;">üå± MISSION:</h3><p style="font-weight: 700;">Merge tiles to find the Plant!</p>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <h4 style="color:#636e72; margin-bottom:5px;">üõ†Ô∏è Eco-Tools:</h4>
                            <div class="powerup-box">
                                <button class="p-btn" onclick="powerupUndo()">‚Ü©Ô∏è Undo<span class="p-cost">1 Token</span></button>
                                <button class="p-btn" onclick="powerupVacuum()">üßπ Clean<span class="p-cost">2 Tokens</span></button>
                                <button class="p-btn" onclick="powerupShuffle()">üå™Ô∏è Wind<span class="p-cost">3 Tokens</span></button>
                            </div>
                        </div>
                        <button onclick="initGame()" style="width: 100%; padding: 15px; font-weight: 800; background:var(--accent); border:none; border-radius:15px; color:var(--primary-dark);">üîÑ Restart Game</button>
                    </div>
                    <div class="game-board-container"><div class="game-grid" id="game-board"></div></div>
                </div>
            </div>

            <div id="page-leaderboard" class="page hidden">
                <header><span class="header-emoji">üèÜ</span><h1>Global Leaderboard</h1></header>
                <p style="margin-bottom:20px; font-weight:bold; color:#636e72;">üåè Real-time Ranking from All Users!</p>
                <div id="leaderboard-list"></div>
            </div>
        </main>
    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî• CONFIG ASLI KAMU (SUDAH AKU ISI) üî•
        const firebaseConfig = {
            apiKey: "AIzaSyDMCkwQoeHzXjM-90fKPI5YGG9tajL95Ks",
            authDomain: "oxygenz-web.firebaseapp.com",
            projectId: "oxygenz-web",
            storageBucket: "oxygenz-web.firebasestorage.app",
            messagingSenderId: "243500806993",
            appId: "1:243500806993:web:087ac3845f4d8fee825970",
            measurementId: "G-ZDNCV0HX03"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // GLOBALS
        let currentUser = null;
        let userData = {};
        const CACHE_KEY = "oxygenz_user_session"; 

        const FACTS = { 4: {title: "Car Pollution", icon: "üöó", text: "Did you know? Cars create a gas called CO2. It works like a thick blanket that warms up the Earth! üåç"}, 8: {title: "Factory Smoke", icon: "üè≠", text: "Factories make things we use, but they release lots of smoke. Filters can help catch the dirt before it flies away! üè≠"}, 16: {title: "Heavy Haze", icon: "üò∂‚Äçüå´Ô∏è", text: "Uh oh! Haze is like a dirty cloud on the ground. When it's hazy, wearing a mask helps you breathe safely! üò∑"}, 32: {title: "Ozone Danger", icon: "‚ö°", text: "Zap! Ground-level Ozone is bad for your lungs. It forms when sunlight cooks car fumes on hot days! ‚òÄÔ∏è"}, 64: {title: "Lungs at Risk", icon: "ü´Å", text: "Your lungs are like pink sponges! Breathing dirty air makes them work too hard. Clean air keeps them happy! üíñ"}, 128: {title: "Plant Power!", icon: "üå±", text: "Victory! Trees are superheroes. They eat the bad CO2 and give us fresh Oxygen. You saved the day! üéâ"} };
        const QUIZ_PACKAGES = [ { id: 1, title: "Indoor Air Quality", icon: "üè†", questions: [{q: "What is a common source of indoor pollution?", options: ["LED bulbs", "Cooking fumes", "Open windows", "Plants"], ans: 1}, {q: "Which toxic gas is odorless?", options: ["Carbon Monoxide", "Sulfur Dioxide", "Oxygen", "Helium"], ans: 0}, {q: "What does a HEPA filter do?", options: ["Heats air", "Traps particles", "Adds scent", "Measures temp"], ans: 1}, {q: "High humidity leads to?", options: ["Dust", "Mold", "Ozone", "Carbon"], ans: 1}, {q: "What are VOCs?", options: ["Vitamins", "Gases from paints", "Bacteria", "Solar energy"], ans: 1}] }, { id: 2, title: "Sustainable Living", icon: "üå±", questions: [{q: "Most effective '3 Rs'?", options: ["Recycle", "Reuse", "Reduce", "Repaint"], ans: 2}, {q: "Most efficient lightbulb?", options: ["Incandescent", "Halogen", "LED", "Fluorescent"], ans: 2}, {q: "What is Composting?", options: ["Burning trash", "Organic waste to soil", "Throwing plastic", "Compressing cans"], ans: 1}, {q: "Diet with lowest carbon footprint?", options: ["Plant-based", "Red meat", "Processed food", "Imported food"], ans: 0}, {q: "'Vampire Power' refers to?", options: ["Solar at night", "Electronics off but plugged", "Batteries leaking", "Bats"], ans: 1}] }, { id: 3, title: "Pollution & Health", icon: "ü´Å", questions: [{q: "Why is PM2.5 dangerous?", options: ["Radioactive", "Sharp", "Enters bloodstream", "Smells bad"], ans: 2}, {q: "Long-term pollution links to?", options: ["Better immune", "Respiratory disease", "Height", "Vision"], ans: 1}, {q: "Most vulnerable group?", options: ["Teenagers", "Children & Elderly", "Office workers", "Athletes"], ans: 1}, {q: "What is Smog?", options: ["Cloud", "Smoke + Fog", "Rock", "Rainstorm"], ans: 1}, {q: "Noise pollution causes?", options: ["Clean air", "Stress & Hearing loss", "Sleep", "Warming"], ans: 1}] }, { id: 4, title: "Energy & Resources", icon: "‚ö°", questions: [{q: "Which is renewable?", options: ["Coal", "Gas", "Wind Energy", "Nuclear"], ans: 2}, {q: "Disadvantage of fossil fuels?", options: ["Expensive", "Greenhouse gases", "Hard to find", "Renewable"], ans: 1}, {q: "Geothermal energy comes from?", options: ["Sun", "Wind", "Heat inside Earth", "Tides"], ans: 2}, {q: "Benefit of EVs?", options: ["Quieter", "Zero tailpipe emissions", "Faster", "No energy"], ans: 1}, {q: "Solar panels convert?", options: ["Light back to space", "Sunlight to electricity", "Heat roof", "Grow plants"], ans: 1}] } ];
        const CHALLENGES = [{id: 1, title: "Open Windows", desc: "Ventilate 10 mins", pts: 50, icon: "ü™ü"}, {id: 2, title: "Add Plant", desc: "Snake Plant", pts: 100, icon: "ü™¥"}, {id: 3, title: "Clean Dust", desc: "Wipe surfaces", pts: 75, icon: "üßπ"}];

        // --- AUTH ---
        window.handleRegister = async () => {
            const u = document.getElementById('auth-user').value.trim(); const p = document.getElementById('auth-pass').value.trim();
            if(!u || !p) return showToast("Please fill all fields!");
            showLoading(true);
            try {
                const docRef = doc(db, "users", u); const docSnap = await getDoc(docRef);
                if(docSnap.exists()) { showToast("Username taken!"); showLoading(false); return; }
                const newData = { pass: p, points: 0, tokens: 5, cleaned: 0, completedChallenges: [], completedQuizzes: [], unlockedTiles: [] };
                await setDoc(docRef, newData);
                localStorage.setItem(CACHE_KEY, u); currentUser = u; userData = newData;
                showDashboard(); showToast("Welcome to OxyGenZ! üåø");
            } catch(e) { console.error(e); showToast("Error connecting to DB: " + e.message); }
            showLoading(false);
        }

        window.handleLogin = async () => {
            const u = document.getElementById('auth-user').value.trim(); const p = document.getElementById('auth-pass').value.trim();
            if(!u || !p) return showToast("Please fill all fields!");
            showLoading(true);
            try {
                const docRef = doc(db, "users", u); const docSnap = await getDoc(docRef);
                if(docSnap.exists() && docSnap.data().pass === p) {
                    localStorage.setItem(CACHE_KEY, u); currentUser = u; userData = docSnap.data();
                    showDashboard(); showToast(`Welcome back, ${u}! üëã`);
                } else { showToast("Invalid Username or Password ‚ùå"); }
            } catch(e) { console.error(e); showToast("Login Error: " + e.message); }
            showLoading(false);
        }
        window.handleLogout = () => { localStorage.removeItem(CACHE_KEY); location.reload(); }
        window.onload = async () => {
            const cachedUser = localStorage.getItem(CACHE_KEY);
            if(cachedUser) {
                showLoading(true);
                try {
                    const docRef = doc(db, "users", cachedUser); const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) { currentUser = cachedUser; userData = docSnap.data(); showDashboard(); } 
                    else { document.getElementById('auth-section').classList.remove('hidden'); }
                } catch(e) { document.getElementById('auth-section').classList.remove('hidden'); }
                showLoading(false);
            }
        };

        async function saveToDB() { if(!currentUser)return; try{ await updateDoc(doc(db, "users", currentUser), userData); }catch(e){} updateUI(); }

        // --- UI & LOGIC ---
        function updateUI() {
            document.getElementById('display-username').innerText = currentUser;
            document.getElementById('stat-points').innerText = userData.points; document.getElementById('stat-tokens').innerText = userData.tokens; document.getElementById('stat-cleaned').innerText = userData.cleaned;
            let aqi = 150 - userData.cleaned; if(aqi<50) aqi=50; document.getElementById('aqi-val').innerText = aqi;
            const stat = document.getElementById('aqi-status'); const circ = document.querySelector('.aqi-circle'); const em = document.getElementById('aqi-emoji');
            if(aqi>100){ stat.innerText="UNHEALTHY"; stat.style.color="#fab1a0"; circ.style.borderColor="#fab1a0"; em.innerText="üå´Ô∏è"; }
            else if(aqi>70){ stat.innerText="MODERATE"; stat.style.color="#ffeaa7"; circ.style.borderColor="#ffeaa7"; em.innerText="üòê"; }
            else{ stat.innerText="EXCELLENT"; stat.style.color="#55efc4"; circ.style.borderColor="#55efc4"; em.innerText="‚ú®"; }
            
            const cCont = document.getElementById('challenges-container'); cCont.innerHTML='';
            CHALLENGES.forEach(c => {
                const done = userData.completedChallenges.includes(c.id);
                const btn = done ? '<button disabled style="background:#b2bec3;color:white;border:none;padding:8px 15px;border-radius:10px;">Done</button>' : `<button onclick="doChallenge(${c.id},${c.pts})" style="background:var(--accent);border:none;padding:8px 15px;border-radius:10px;font-weight:800;color:var(--primary-dark);">Complete</button>`;
                cCont.innerHTML += `<div class="rank-card" style="padding:15px;"><div><span style="font-size:1.5rem;margin-right:10px;">${c.icon}</span><b>${c.title}</b></div>${btn}</div>`;
            });
            const qMenu = document.getElementById('quiz-menu'); qMenu.innerHTML = ''; let completedCount = 0;
            QUIZ_PACKAGES.forEach(pkg => {
                const isDone = userData.completedQuizzes && userData.completedQuizzes.includes(pkg.id); if(isDone) completedCount++;
                const statusHtml = isDone ? '<span style="color:var(--primary); font-weight:800;">‚úÖ Completed</span>' : '<span class="quiz-reward">üèÜ +50 Pts</span>';
                const clickAction = isDone ? `showToast("You already finished this quiz!")` : `initQuiz(${pkg.id})`;
                const opacity = isDone ? 'opacity: 0.6;' : '';
                qMenu.innerHTML += `<div class="quiz-card-item" onclick='${clickAction}' style="${opacity}"><span class="quiz-icon">${pkg.icon}</span><h3 class="quiz-title">${pkg.title}</h3>${statusHtml}</div>`;
            });
            document.getElementById('quizzes-completed').innerText = completedCount;
        }

        window.showPage = async (pid) => {
            document.querySelectorAll('.page').forEach(e=>e.classList.add('hidden')); document.getElementById(`page-${pid}`).classList.remove('hidden');
            document.querySelectorAll('.nav-links li').forEach(e=>e.classList.remove('active-nav')); document.getElementById(`nav-${pid}`).classList.add('active-nav');
            
            // BACKGROUND LOGIC
            const body = document.body;
            if(pid === 'game') {
                window.addEventListener('keydown', handleGameKey); 
                if(gameBoard.every(r=>r.every(v=>v===0))) initGame();
                let max = 0; gameBoard.forEach(r=>r.forEach(v=>{if(v>max)max=v;})); updateEnvironment(max);
            } else {
                window.removeEventListener('keydown', handleGameKey);
                body.classList.remove('env-polluted', 'env-moderate', 'env-clean');
            }

            if(pid==='leaderboard') {
                showLoading(true);
                const list = document.getElementById('leaderboard-list'); list.innerHTML = '';
                try {
                    const q = query(collection(db, "users"), orderBy("points", "desc"), limit(10));
                    const querySnapshot = await getDocs(q); let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const u = doc.data(); const name = doc.id;
                        let rankClass = rank < 4 ? `rank-${rank}` : ''; let medal = rank===1 ? 'ü•á' : rank===2 ? 'ü•à' : rank===3 ? 'ü•â' : `#${rank}`;
                        list.innerHTML += `<div class="rank-card ${rankClass}"><div class="rank-num">${medal}</div><div class="rank-name">${name}</div><div class="rank-score">üèÜ ${u.points}</div></div>`; rank++;
                    });
                } catch(e) { list.innerHTML = "<p>Error loading leaderboard.</p>"; }
                showLoading(false);
            }
        }

        window.doChallenge = async (id, pts) => { userData.completedChallenges.push(id); userData.points+=pts; userData.cleaned+=20; userData.tokens+=3; await saveToDB(); showToast(`+${pts} Pts!`); triggerBalloons(); }
        
        let gameBoard=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]; let gameScore=0; let prevBoard=null; let prevScore=0;
        let activeQuiz = null; let currentQIdx = 0; let quizAnswers = [];

        window.initGame = () => { gameBoard=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]; gameScore=0; prevBoard=null; addTile(); addTile(); drawBoard(); updateEnvironment(0); }
        function drawBoard(){ const d=document.getElementById('game-board'); d.innerHTML=''; let maxVal=0; gameBoard.forEach(r=>r.forEach(v=>{ if(v>maxVal)maxVal=v; const t=document.createElement('div'); t.className=`tile t-${v}`; t.innerText=v>0?getIcon(v):''; d.appendChild(t); })); document.getElementById('game-score').innerText=gameScore; updateEnvironment(maxVal); }
        function getIcon(v){ const i={2:'üå´Ô∏è',4:'üöó',8:'üè≠',16:'üò∂‚Äçüå´Ô∏è',32:'‚ö°',64:'ü´Å',128:'üå±'}; return i[v]||v; }
        function addTile(){ let e=[]; for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(gameBoard[r][c]===0)e.push({r,c}); if(e.length){ const s=e[Math.floor(Math.random()*e.length)]; gameBoard[s.r][s.c]=2; } }
        window.handleGameKey = (e) => { if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)){ e.preventDefault(); prevBoard=JSON.parse(JSON.stringify(gameBoard)); prevScore=gameScore; let m=false; if(e.key==='ArrowUp')m=move(0); if(e.key==='ArrowRight')m=move(1); if(e.key==='ArrowDown')m=move(2); if(e.key==='ArrowLeft')m=move(3); if(m){ addTile(); drawBoard(); checkNewDiscovery(); if(gameBoard.some(r=>r.some(v=>v>=128))) { showModal("üå± Victory!", "You created a Plant! Nature is restored!", "Play Again"); initGame(); } } } }
        function move(dir){ let m=false; const rot=dir===0?3:dir===1?2:dir===2?1:0; for(let i=0;i<rot;i++) rotate(); for(let r=0;r<4;r++){ let row=gameBoard[r].filter(v=>v); for(let i=0;i<row.length-1;i++){ if(row[i]===row[i+1]){ row[i]*=2; let p = row[i]; gameScore += p; userData.points += p; saveToDB(); row[i+1]=0; } } row=row.filter(v=>v); while(row.length<4)row.push(0); if(JSON.stringify(gameBoard[r])!==JSON.stringify(row))m=true; gameBoard[r]=row; } for(let i=0;i<(4-rot)%4;i++) rotate(); return m; }
        function rotate(){ let n=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]; for(let r=0;r<4;r++)for(let c=0;c<4;c++)n[c][3-r]=gameBoard[r][c]; gameBoard=n; }
        
        window.powerupUndo = async () => { if(userData.tokens<1) return showToast("Need 1 Token"); if(!prevBoard) return showToast("Can't Undo"); userData.tokens-=1; await saveToDB(); gameBoard=JSON.parse(JSON.stringify(prevBoard)); gameScore=prevScore; drawBoard(); showToast("Undone!"); }
        window.powerupVacuum = async () => { if(userData.tokens<2) return showToast("Need 2 Tokens"); userData.tokens-=2; await saveToDB(); let rem=false; for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(gameBoard[r][c]===2||gameBoard[r][c]===4){gameBoard[r][c]=0;rem=true;} if(rem){drawBoard();showToast("Cleaned!");} }
        window.powerupShuffle = async () => { if(userData.tokens<3) return showToast("Need 3 Tokens"); userData.tokens-=3; await saveToDB(); let t=[]; for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(gameBoard[r][c]!==0)t.push(gameBoard[r][c]); t.sort(()=>Math.random()-0.5); gameBoard=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]; let i=0; for(let r=0;r<4;r++)for(let c=0;c<4;c++)if(i<t.length){gameBoard[r][c]=t[i];i++;} drawBoard(); showToast("Shuffled!"); }

        window.initQuiz = (id) => { activeQuiz=QUIZ_PACKAGES.find(p=>p.id===id); currentQIdx=0; quizAnswers=new Array(activeQuiz.questions.length).fill(null); document.getElementById('quiz-menu-card').classList.add('hidden'); document.getElementById('quiz-interface-card').classList.remove('hidden'); document.getElementById('active-quiz-title').innerText=activeQuiz.title; document.getElementById('quiz-result-view').classList.add('hidden'); document.getElementById('quiz-game-area').classList.remove('hidden'); renderQuestion(); }
        function renderQuestion() { const q=activeQuiz.questions[currentQIdx]; document.getElementById('q-progress-text').innerText=`Question ${currentQIdx+1}`; document.getElementById('q-text').innerText=q.q; const d=document.getElementById('q-options'); d.innerHTML=''; const done=quizAnswers[currentQIdx]!==null; q.options.forEach((o,i)=>{ let c="option-btn"; if(done){c+=" disabled"; c+=i===q.ans?" correct":i===quizAnswers[currentQIdx]?" wrong":"";} d.innerHTML+=`<button class="${c}" onclick="selectAnswer(${i})"><span class="option-marker">${['A','B','C','D'][i]}</span> ${o}</button>`; }); document.getElementById('btn-prev').style.visibility=currentQIdx===0?'hidden':'visible'; const last=currentQIdx===activeQuiz.questions.length-1; document.getElementById('btn-next').className=last?'hidden':'nav-btn btn-next'; document.getElementById('btn-submit-quiz').className=last?'btn-submit':'hidden'; }
        window.selectAnswer = (i) => { if(quizAnswers[currentQIdx]!==null)return; quizAnswers[currentQIdx]=i; if(i===activeQuiz.questions[currentQIdx].ans)showToast("Correct!"); else showToast("Wrong!"); renderQuestion(); }
        window.nextQuestion = () => { currentQIdx++; renderQuestion(); }
        window.prevQuestion = () => { currentQIdx--; renderQuestion(); }
        window.submitQuiz = async () => { if(quizAnswers.includes(null)){showToast("Answer all!");return;} let s=0; activeQuiz.questions.forEach((q,i)=>{if(quizAnswers[i]===q.ans)s+=10;}); if(!userData.completedQuizzes.includes(activeQuiz.id)){userData.completedQuizzes.push(activeQuiz.id); userData.points+=s; userData.tokens+=2; await saveToDB();} document.getElementById('quiz-game-area').classList.add('hidden'); document.getElementById('quiz-result-view').classList.remove('hidden'); document.getElementById('final-score-display').innerText=s; document.getElementById('reward-pts').innerText=s; triggerBalloons(); }
        window.closeQuiz = () => { document.getElementById('quiz-interface-card').classList.add('hidden'); document.getElementById('quiz-menu-card').classList.remove('hidden'); updateUI(); }

        function updateEnvironment(max) { const b=document.body; b.classList.remove('env-polluted','env-moderate','env-clean'); if(max>=64)b.classList.add('env-clean'); else if(max>=32)b.classList.add('env-moderate'); else b.classList.add('env-polluted'); }
        function checkNewDiscovery() { let max=0; gameBoard.forEach(r=>r.forEach(v=>{if(v>max)max=v;})); if(FACTS[max] && !userData.unlockedTiles.includes(max)){ userData.unlockedTiles.push(max); saveToDB(); showModal(FACTS[max].title, FACTS[max].text, "Nice!", FACTS[max].icon); } }
        window.showModal = (t, txt, b, e="üåü") => { document.getElementById('modal-emoji').innerText=e; document.getElementById('modal-title').innerText=t; document.getElementById('modal-text').innerText=txt; document.querySelector('.modal-btn').innerText=b; document.getElementById('modal-overlay').classList.remove('hidden'); }
        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        window.showDashboard = () => { document.getElementById('auth-section').classList.add('hidden'); document.getElementById('dashboard-section').classList.remove('hidden'); showPage('overview'); updateUI(); }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),2000); }
        function showLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }
        function triggerBalloons() { const c=document.getElementById('baloon-container'); for(let i=0;i<15;i++){ const b=document.createElement('div'); b.className='baloon'; b.innerText=['üéà','üéâ','‚ú®'][Math.floor(Math.random()*3)]; b.style.left=Math.random()*100+'%'; b.style.animationDelay=Math.random()*2+'s'; c.appendChild(b); setTimeout(()=>b.remove(),4000); } }
    </script>
</body>
</html>